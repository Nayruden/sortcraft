name: build

on:
  push:
  pull_request:

jobs:
  # Run tests first - tests are only available for Minecraft 1.21.5
  test:
    name: Run Tests
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Clean
        run: ./gradlew clean "-Pmc_version=1.21.5" --no-daemon

      - name: Run Tests (JUnit + GameTest)
        run: ./gradlew :fabric:test :common:test "-Pmc_version=1.21.5" --no-daemon

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            fabric/build/reports/tests/
            common/build/reports/tests/
          if-no-files-found: ignore

  build:
    name: Build for Minecraft ${{ matrix.mc_version }}
    runs-on: ubuntu-24.04
    needs: test
    strategy:
      fail-fast: false
      matrix:
        mc_version:
          - "1.21.1"
          - "1.21.4"
          - "1.21.5"
          - "1.21.6"
          - "1.21.7"
          - "1.21.8"
          - "1.21.9"
          - "1.21.10"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Clean for ${{ matrix.mc_version }}
        run: ./gradlew clean "-Pmc_version=${{ matrix.mc_version }}" --no-daemon

      - name: Build for ${{ matrix.mc_version }}
        run: ./gradlew build "-Pmc_version=${{ matrix.mc_version }}" -x test --no-daemon

      - name: Collect artifacts
        run: |
          mkdir -p build/libs/all-versions
          for dir in fabric/build/libs neoforge/build/libs; do
            if [ -d "$dir" ]; then
              find "$dir" -maxdepth 1 -type f -name "*+${{ matrix.mc_version }}.jar" \
                ! -name "*-sources*" ! -name "*-dev*" -exec cp {} build/libs/all-versions/ \;
            fi
          done

      - name: Capture build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sortcraft-${{ matrix.mc_version }}
          path: build/libs/all-versions/*+${{ matrix.mc_version }}.jar
          if-no-files-found: error
